import { auth, db } from './firebase-config.js';
import { 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword,
    signOut,
    onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import { 
    doc, 
    getDoc, 
    setDoc, 
    collection, 
    query, 
    where, 
    getDocs,
    updateDoc,
    serverTimestamp,
    addDoc
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
export async function loginUser(email, password, userType, rememberMe = false) {
    try {
        // ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô Firebase ‡∏à‡∏£‡∏¥‡∏á
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Firestore
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (userData.userType !== userType) {
                throw new Error('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
            if (userData.userType === 'instructor' || userData.userType === 'admin') {
                if (userData.approvalStatus === 'pending') {
                    throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
                } else if (userData.approvalStatus === 'rejected') {
                    throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
                }
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            await updateDoc(doc(db, 'users', user.uid), {
                lastLoginAt: serverTimestamp(),
                loginCount: (userData.loginCount || 0) + 1
            });
            
            const userInfo = {
                uid: user.uid,
                email: user.email,
                userType: userData.userType,
                name: userData.name,
                profile: userData.profile || {},
                approvalStatus: userData.approvalStatus || 'approved',
                isDemo: false,
                loginTime: new Date().toISOString()
            };
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô"
            if (rememberMe) {
                localStorage.setItem('user', JSON.stringify(userInfo));
                localStorage.setItem('rememberMe', 'true');
            } else {
                sessionStorage.setItem('user', JSON.stringify(userInfo));
                localStorage.removeItem('rememberMe');
            }
            
            return { success: true, user: userInfo };
        } else {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        }
        
    } catch (error) {
        console.error('Login error:', error);
        
        // ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else if (error.code === 'auth/too-many-requests') {
            errorMessage = '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        return { success: false, error: errorMessage };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
export async function registerUser(email, password, userData) {
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore
        await setDoc(doc(db, 'users', user.uid), {
            ...userData,
            email: email,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            loginCount: 0,
            isActive: true
        });
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö
        try {
            await addDoc(collection(db, 'system_activities'), {
                title: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
                description: `${userData.name || userData.firstName + ' ' + userData.lastName} (${email}) ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà`,
                type: 'user_registration',
                timestamp: serverTimestamp(),
                userId: user.uid
            });
        } catch (error) {
            console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ:', error);
        }
        
        return { success: true, user: user };
        
    } catch (error) {
        console.error('Registration error:', error);
        
        // ‡πÅ‡∏õ‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        return { success: false, error: errorMessage };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Firestore
export async function getUserData(uid) {
    try {
        const userDoc = await getDoc(doc(db, 'users', uid));
        if (userDoc.exists()) {
            return { success: true, data: userDoc.data() };
        } else {
            return { success: false, error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' };
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
export async function updateUserData(uid, updateData) {
    try {
        await updateDoc(doc(db, 'users', uid), {
            ...updateData,
            updatedAt: serverTimestamp()
        });
        return { success: true };
    } catch (error) {
        console.error('Error updating user data:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
export async function getUserCourses(uid) {
    try {
        const coursesQuery = query(
            collection(db, 'enrollments'),
            where('userId', '==', uid),
            where('status', '==', 'active')
        );
        
        const querySnapshot = await getDocs(coursesQuery);
        const enrollments = [];
        
        querySnapshot.forEach((doc) => {
            enrollments.push({ id: doc.id, ...doc.data() });
        });
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™
        const courses = [];
        for (const enrollment of enrollments) {
            const courseDoc = await getDoc(doc(db, 'courses', enrollment.courseId));
            if (courseDoc.exists()) {
                courses.push({
                    ...courseDoc.data(),
                    enrollmentId: enrollment.id,
                    progress: enrollment.progress || 0,
                    status: enrollment.status
                });
            }
        }
        
        return { success: true, data: courses };
    } catch (error) {
        console.error('Error fetching user courses:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
export async function getUserQuizzes(uid) {
    try {
        const quizzesQuery = query(
            collection(db, 'quiz_results'),
            where('userId', '==', uid)
        );
        
        const querySnapshot = await getDocs(quizzesQuery);
        const results = [];
        
        querySnapshot.forEach((doc) => {
            results.push({ id: doc.id, ...doc.data() });
        });
        
        return { success: true, data: results };
    } catch (error) {
        console.error('Error fetching user quizzes:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
export async function getUserStatistics(uid) {
    try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™
        const coursesResult = await getUserCourses(uid);
        const courses = coursesResult.success ? coursesResult.data : [];
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
        const quizzesResult = await getUserQuizzes(uid);
        const quizzes = quizzesResult.success ? quizzesResult.data : [];
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        const totalCourses = courses.length;
        const completedCourses = courses.filter(course => course.progress >= 100).length;
        const totalQuizzes = quizzes.length;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        const completedQuizzes = quizzes.filter(quiz => quiz.score !== undefined);
        const averageScore = completedQuizzes.length > 0 
            ? Math.round(completedQuizzes.reduce((sum, quiz) => sum + quiz.score, 0) / completedQuizzes.length)
            : 0;
        
        return {
            success: true,
            data: {
                totalCourses,
                completedCourses,
                totalQuizzes,
                averageScore: `${averageScore}%`
            }
        };
    } catch (error) {
        console.error('Error calculating user statistics:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
export async function logoutUser() {
    try {
        await signOut(auth);
        
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á sessionStorage ‡πÅ‡∏•‡∏∞ localStorage
        sessionStorage.removeItem('user');
        localStorage.removeItem('user');
        localStorage.removeItem('rememberMe');
        
        return { success: true };
    } catch (error) {
        console.error('Logout error:', error);
        return { success: false, error: error.message };
    }
}

// ‡∏î‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
export function getCurrentUser() {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
    if (window.saveLog) {
        window.saveLog('AUTH.JS: getCurrentUser ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }
    console.log('üîç getCurrentUser: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å sessionStorage ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏à‡∏î‡∏à‡∏≥)
    let user = sessionStorage.getItem('user');
    if (window.saveLog) {
        window.saveLog('AUTH.JS: sessionStorage', user ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    }
    console.log('üîç getCurrentUser: sessionStorage =', user ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô sessionStorage ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏à‡∏≥)
    if (!user) {
        user = localStorage.getItem('user');
        if (window.saveLog) {
            window.saveLog('AUTH.JS: localStorage', user ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
        console.log('üîç getCurrentUser: localStorage =', user ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    }
    
    if (user) {
        try {
            const userData = JSON.parse(user);
            if (window.saveLog) {
                window.saveLog('AUTH.JS: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', userData.userType);
            }
            console.log('üîç getCurrentUser: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', userData.userType);
            return userData;
        } catch (error) {
            if (window.saveLog) {
                window.saveLog('AUTH.JS: Error parsing user data', error.message);
            }
            console.error('‚ùå getCurrentUser: Error parsing user data:', error);
            return null;
        }
    }
    
    if (window.saveLog) {
        window.saveLog('AUTH.JS: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }
    console.log('üîç getCurrentUser: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    return null;
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
export function onAuthStateChange(callback) {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            callback(user);
        } else {
            // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            callback(null);
        }
    });
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
export function redirectBasedOnUserType(userType) {
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ redirect ‡∏ã‡πâ‡∏≥‡πÜ
    const currentPath = window.location.pathname;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
    if (window.saveLog) {
        window.saveLog('AUTH.JS: redirectBasedOnUserType ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å');
        window.saveLog('AUTH.JS: userType', userType);
        window.saveLog('AUTH.JS: currentPath', currentPath);
        window.saveLog('AUTH.JS: isRedirecting', window.isRedirecting);
    }
    
    console.log('üîÑ redirectBasedOnUserType: ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å');
    console.log('üîÑ redirectBasedOnUserType: userType =', userType);
    console.log('üîÑ redirectBasedOnUserType: currentPath =', currentPath);
    console.log('üîÑ redirectBasedOnUserType: isRedirecting =', window.isRedirecting);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ dashboard ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (currentPath.includes('/dashboard/') && 
        currentPath.includes(`${userType}-dashboard.html`)) {
        console.log('‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ dashboard ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect');
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (window.isRedirecting) {
        console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ã‡πâ‡∏≥');
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ dashboard ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (currentPath.includes('/dashboard/')) {
        console.log('‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ dashboard ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect');
        return;
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ redirect
    window.isRedirecting = true;
    console.log('‡πÄ‡∏£‡∏¥‡πà‡∏° redirect ‡πÑ‡∏õ‡∏¢‡∏±‡∏á:', userType);
    
    // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô throttling
    setTimeout(() => {
        try {
            let targetUrl = '';
            switch (userType) {
                case 'student':
                    if (!currentPath.includes('student-dashboard.html')) {
                        targetUrl = '../dashboard/student-dashboard.html';
                    }
                    break;
                case 'instructor':
                    if (!currentPath.includes('instructor-dashboard.html')) {
                        targetUrl = '../dashboard/instructor-dashboard.html';
                    }
                    break;
                case 'admin':
                    if (!currentPath.includes('admin-dashboard.html')) {
                        targetUrl = '../dashboard/admin-dashboard.html';
                    }
                    break;
                default:
                    if (!currentPath.includes('login.html')) {
                        targetUrl = '../auth/login.html';
                    }
            }
            
            if (targetUrl) {
                console.log('redirect ‡πÑ‡∏õ‡∏¢‡∏±‡∏á:', targetUrl);
                window.location.href = targetUrl;
            } else {
                console.log('‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect');
                window.isRedirecting = false;
            }
        } catch (error) {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ redirect:', error);
            window.isRedirecting = false;
        }
    }, 500);
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
export function checkUserPermission(requiredUserType) {
    console.log('üîê checkUserPermission: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
    console.log('üîê checkUserPermission: requiredUserType =', requiredUserType);
    
    const currentUser = getCurrentUser();
    
    if (!currentUser) {
        console.log('üîê checkUserPermission: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        return false;
    }
    
    console.log('üîê checkUserPermission: currentUser.userType =', currentUser.userType);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    if (Array.isArray(requiredUserType)) {
        const hasPermission = requiredUserType.includes(currentUser.userType);
        console.log('üîê checkUserPermission: requiredUserType ‡πÄ‡∏õ‡πá‡∏ô array, hasPermission =', hasPermission);
        return hasPermission;
    }
    
    const hasPermission = currentUser.userType === requiredUserType;
    console.log('üîê checkUserPermission: requiredUserType ‡πÄ‡∏õ‡πá‡∏ô string, hasPermission =', hasPermission);
    return hasPermission;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
export function protectPage(requiredUserType) {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
    if (window.saveLog) {
        window.saveLog('AUTH.JS: protectPage ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å');
        window.saveLog('AUTH.JS: requiredUserType', requiredUserType);
        window.saveLog('AUTH.JS: currentPath', window.location.pathname);
        window.saveLog('AUTH.JS: isProtectingPage', window.isProtectingPage);
    }
    
    console.log('üõ°Ô∏è protectPage: ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å');
    console.log('üõ°Ô∏è protectPage: requiredUserType =', requiredUserType);
    console.log('üõ°Ô∏è protectPage: currentPath =', window.location.pathname);
    console.log('üõ°Ô∏è protectPage: isProtectingPage =', window.isProtectingPage);
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÜ
    if (window.isProtectingPage) {
        if (window.saveLog) {
            window.saveLog('AUTH.JS: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥');
        }
        console.log('üõ°Ô∏è protectPage: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥');
        return;
    }
    
    window.isProtectingPage = true;
    if (window.saveLog) {
        window.saveLog('AUTH.JS: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
    }
    console.log('üõ°Ô∏è protectPage: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
    
    try {
        console.log('üõ°Ô∏è protectPage: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        const currentUser = getCurrentUser();
        
        if (!currentUser) {
            console.log('üõ°Ô∏è protectPage: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login');
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
            if (!window.isRedirecting) {
                console.log('üõ°Ô∏è protectPage: ‡πÄ‡∏£‡∏¥‡πà‡∏° redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login');
                setTimeout(() => {
                    window.location.href = '../auth/login.html';
                }, 1000);
            } else {
                console.log('üõ°Ô∏è protectPage: ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ã‡πâ‡∏≥');
            }
            return;
        }
        
        console.log('üõ°Ô∏è protectPage: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:', currentUser.userType);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
        console.log('üõ°Ô∏è protectPage: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
        const hasPermission = checkUserPermission(requiredUserType);
        console.log('üõ°Ô∏è protectPage: hasPermission =', hasPermission);
        
        if (!hasPermission) {
            console.log('üõ°Ô∏è protectPage: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect');
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
            if (!window.isRedirecting) {
                console.log('üõ°Ô∏è protectPage: ‡πÄ‡∏£‡∏¥‡πà‡∏° redirect ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                setTimeout(() => {
                    redirectBasedOnUserType(currentUser.userType);
                }, 1000);
            } else {
                console.log('üõ°Ô∏è protectPage: ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ã‡πâ‡∏≥');
            }
            return;
        }
        
        console.log('üõ°Ô∏è protectPage: ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        displayUserInfo();
        
    } catch (error) {
        console.error('‚ùå protectPage: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
    } finally {
        window.isProtectingPage = false;
        console.log('üõ°Ô∏è protectPage: ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ dashboard
export function displayUserInfo() {
    const currentUser = getCurrentUser();
    
    if (!currentUser) return;
    
    const userTypeText = {
        'student': '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
        'instructor': '‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô',
        'admin': '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'
    };
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï userName element (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö navbar)
    const userNameElement = document.getElementById('userName');
    if (userNameElement) {
        const userType = userTypeText[currentUser.userType] || currentUser.userType;
        userNameElement.textContent = userType;
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï userInfo element (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dashboard)
    const userInfoElement = document.getElementById('userInfo');
    if (userInfoElement) {
        userInfoElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="avatar me-3">
                    <i class="bi bi-person-circle fs-1 text-primary"></i>
                </div>
                <div>
                    <h6 class="mb-0">${currentUser.name || currentUser.email}</h6>
                    <small class="text-muted">${userTypeText[currentUser.userType] || currentUser.userType}</small>
                </div>
            </div>
        `;
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
export function createMainMenu() {
    const currentUser = getCurrentUser();
    const menuContainer = document.getElementById('mainMenu');
    
    if (!menuContainer || !currentUser) return;
    
    const mainMenuItems = {
        'student': [
            { text: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', icon: 'bi-house', href: '../dashboard/student-dashboard.html' },
            { text: '‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', icon: 'bi-book', href: '../courses/course-list.html' },
            { text: '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', icon: 'bi-question-circle', href: '../quiz/quiz-list.html' },
            { text: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', icon: 'bi-graph-up', href: '../courses/student-results.html' },
            { text: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå', icon: 'bi-person', href: '../courses/profile.html' }
        ],
        'instructor': [
            { text: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', icon: 'bi-house', href: '../dashboard/instructor-dashboard.html' },
            { text: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™', icon: 'bi-book', href: '../courses/manage-courses.html' },
            { text: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', icon: 'bi-plus-circle', href: '../quiz/quiz-create.html' },
            { text: '‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', icon: 'bi-graph-up', href: '../courses/student-results.html' },
            { text: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå', icon: 'bi-person', href: '../courses/profile.html' }
        ],
        'admin': [
            { text: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', icon: 'bi-house', href: '../dashboard/admin-dashboard.html' },
            { text: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', icon: 'bi-people', href: '../users/manage-users.html' },
            { text: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™', icon: 'bi-book', href: '../courses/manage-courses.html' },
            { text: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', icon: 'bi-question-circle', href: '../quiz/manage-quizzes.html' },
            { text: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', icon: 'bi-graph-up', href: '../reports/system-reports.html' },
            { text: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', icon: 'bi-gear', href: '../settings/system-settings.html' }
        ]
    };
    
    const items = mainMenuItems[currentUser.userType] || [];
    
    menuContainer.innerHTML = items.map(item => {
        const currentPath = window.location.pathname;
        let isActive = false;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤ active ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        if (item.text === '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å') {
            isActive = currentPath.includes('dashboard');
        } else if (item.text === '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ') {
            isActive = currentPath.includes('manage-users.html') || currentPath.includes('user-detail.html') || currentPath.includes('user-edit.html');
        } else if (item.text === '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™') {
            isActive = currentPath.includes('manage-courses.html') || currentPath.includes('course-list.html');
        } else if (item.text === '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö') {
            isActive = currentPath.includes('manage-quizzes.html') || currentPath.includes('quiz-create.html') || currentPath.includes('quiz-list.html');
        } else if (item.text === '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö') {
            isActive = currentPath.includes('system-reports.html');
        } else if (item.text === '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤') {
            isActive = currentPath.includes('system-settings.html');
        } else if (item.text === '‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô') {
            isActive = currentPath.includes('course-list.html');
        } else if (item.text === '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö') {
            isActive = currentPath.includes('quiz-list.html') || currentPath.includes('quiz-take.html');
        } else if (item.text === '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') {
            isActive = currentPath.includes('student-results.html');
        } else if (item.text === '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå') {
            isActive = currentPath.includes('profile.html');
        } else if (item.text === '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö') {
            isActive = currentPath.includes('quiz-create.html');
        } else if (item.text === '‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') {
            isActive = currentPath.includes('student-results.html');
        }
        
        return `
            <li class="nav-item">
                <a class="nav-link ${isActive ? 'active' : ''}" href="${item.href}">
                    <i class="${item.icon} me-1"></i>
                    ${item.text}
                </a>
            </li>
        `;
    }).join('');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
export function createUserMenu() {
    const currentUser = getCurrentUser();
    const menuContainer = document.getElementById('userMenu');
    
    if (!menuContainer || !currentUser) return;
    
    const menuItems = {
        'student': [
            { text: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', icon: 'bi-box-arrow-right', href: '#', action: 'logout' }
        ],
        'instructor': [
            { text: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', icon: 'bi-box-arrow-right', href: '#', action: 'logout' }
        ],
        'admin': [
            { text: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', icon: 'bi-box-arrow-right', href: '#', action: 'logout' }
        ]
    };
    
    const items = menuItems[currentUser.userType] || [];
    
    menuContainer.innerHTML = items.map(item => `
        <li>
            <a class="dropdown-item" href="${item.href}" ${item.action ? `data-action="${item.action}"` : ''}>
                <i class="${item.icon} me-2"></i>
                ${item.text}
            </a>
        </li>
    `).join('');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á session
export function checkSessionExpiry() {
    const currentUser = getCurrentUser();
    
    if (!currentUser || !currentUser.loginTime) {
        return false;
    }
    
    const loginTime = new Date(currentUser.loginTime);
    const currentTime = new Date();
    const timeDiff = currentTime - loginTime;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö session ‡∏õ‡∏Å‡∏ï‡∏¥)
    const maxSessionTime = 24 * 60 * 60 * 1000; // 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÉ‡∏ô‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
    if (timeDiff > maxSessionTime) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        logoutUser();
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô redirect
        if (!window.location.pathname.includes('login.html')) {
            window.location.href = '../auth/login.html';
        }
        return false;
    }
    
    return true;
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    
    if (loginForm) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô" ‡∏à‡∏≤‡∏Å localStorage
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        const rememberMeCheckbox = document.getElementById('rememberMe');
        if (rememberMeCheckbox) {
            rememberMeCheckbox.checked = rememberMe;
        }
        
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            submitBtn.disabled = true;
            
            try {
                const result = await loginUser(email, password, userType, rememberMe);
                
                if (result.success) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    showAlert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏ã‡πâ‡∏≥
                    submitBtn.disabled = true;
                    
                    console.log('Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect...');
                    
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                    setTimeout(() => {
                        if (!window.isRedirecting) {
                            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏° redirect ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            redirectBasedOnUserType(userType);
                        } else {
                            console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ã‡πâ‡∏≥');
                        }
                    }, 2500);
                    
                } else {
                    showAlert(result.error, 'danger');
                }
                
            } catch (error) {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'danger');
            } finally {
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
function showAlert(message, type) {
    // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
    const existingAlert = document.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    const form = document.getElementById('loginForm');
    if (form) {
        form.parentNode.insertBefore(alertDiv, form);
    }
    
    // ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô)
export function showSuccessMessage(message) {
    showAlert(message, 'success');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô)
export function showErrorMessage(message) {
    showAlert(message, 'danger');
}

// Reset ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
if (typeof window.isRedirecting === 'undefined') {
    window.isRedirecting = false;
}
if (typeof window.hasCheckedAuth === 'undefined') {
    window.hasCheckedAuth = false;
}
if (typeof window.isProtectingPage === 'undefined') {
    window.isProtectingPage = false;
}

// Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
console.log('üîß AUTH.JS: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
console.log('üîß AUTH.JS: isRedirecting =', window.isRedirecting);
console.log('üîß AUTH.JS: hasCheckedAuth =', window.hasCheckedAuth);
console.log('üîß AUTH.JS: isProtectingPage =', window.isProtectingPage);
console.log('üîß AUTH.JS: current path =', window.location.pathname);

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
document.addEventListener('DOMContentLoaded', function() {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log
    if (window.saveLog) {
        window.saveLog('AUTH.JS: DOMContentLoaded ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
    }
    console.log('üìÑ DOMContentLoaded: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const currentPath = window.location.pathname;
    const isLoginPage = currentPath.includes('login.html');
    const isRegisterPage = currentPath.includes('register.html');
    const isHomePage = currentPath === '/' || currentPath.endsWith('/') || currentPath.endsWith('index.html');
    
    if (window.saveLog) {
        window.saveLog('AUTH.JS: currentPath', currentPath);
        window.saveLog('AUTH.JS: isLoginPage', isLoginPage);
        window.saveLog('AUTH.JS: isRegisterPage', isRegisterPage);
        window.saveLog('AUTH.JS: isHomePage', isHomePage);
    }
    
    console.log('üìÑ DOMContentLoaded: currentPath =', currentPath);
    console.log('üìÑ DOMContentLoaded: isLoginPage =', isLoginPage);
    console.log('üìÑ DOMContentLoaded: isRegisterPage =', isRegisterPage);
    console.log('üìÑ DOMContentLoaded: isHomePage =', isHomePage);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login, register ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    if (isLoginPage || isRegisterPage || isHomePage) {
        console.log('üìÑ DOMContentLoaded: ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ login/register/home');
        
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡πÜ
        if (window.hasCheckedAuth) {
            console.log('üìÑ DOMContentLoaded: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥');
            return;
        }
        
        window.hasCheckedAuth = true;
        console.log('üìÑ DOMContentLoaded: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤:', currentPath);
        
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        setTimeout(() => {
            console.log('üìÑ DOMContentLoaded: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤');
            const currentUser = getCurrentUser();
            if (currentUser && !window.isRedirecting) {
                console.log('üìÑ DOMContentLoaded: ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect...');
                redirectBasedOnUserType(currentUser.userType);
            } else {
                console.log('üìÑ DOMContentLoaded: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏≠‡∏¢‡∏π‡πà');
            }
        }, 1500);
    } else {
        console.log('üìÑ DOMContentLoaded: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏ô‡πâ‡∏≤ login/register/home ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }
});
