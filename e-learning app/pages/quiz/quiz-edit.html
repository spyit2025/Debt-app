<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แก้ไขข้อสอบ - E-Learning Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    
    <style>
        /* Fallback Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
        }
        
        .modal.show {
            display: block !important;
            z-index: 1050;
        }
        
        .modal-open {
            overflow: hidden;
        }
        
        /* ปรับปรุงการแสดงปุ่ม */
        .btn-toolbar .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-toolbar .btn {
            white-space: nowrap;
        }
        
        /* ปรับปรุง Modal */
        .modal-xl {
            max-width: 90%;
        }
        
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 95%;
                margin: 1rem;
            }
            
            .btn-toolbar .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-toolbar .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Accessibility improvements */
        .modal[aria-hidden="true"] {
            pointer-events: none;
        }

        .modal[aria-hidden="true"] .modal-dialog {
            pointer-events: none;
        }

        .modal:not([aria-hidden="true"]) {
            pointer-events: auto;
        }

        .modal:not([aria-hidden="true"]) .modal-dialog {
            pointer-events: auto;
        }

        /* Focus management */
        .modal.show .modal-content {
            outline: none;
        }

        .modal.show .btn-close:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        /* Ensure proper focus management */
        .modal-backdrop {
            pointer-events: auto;
        }

        /* Status container styles */
        .status-container-hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="../dashboard/instructor-dashboard.html">
                <i class="bi bi-mortarboard-fill me-2"></i>
                E-Learning Platform
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" title="เปิด/ปิดเมนู">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto" id="mainMenu">
                    <!-- เมนูจะถูกสร้างโดย JavaScript -->
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" id="userDropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="userName">ผู้สอน</span>
                        </a>
                        <ul class="dropdown-menu" id="userMenu">
                            <!-- เมนูผู้ใช้จะถูกสร้างโดย JavaScript -->
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <main class="col-12 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-pencil-square me-2"></i>
                        แก้ไขข้อสอบ
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createQuizModal">
                                <i class="bi bi-plus-circle me-1"></i>สร้างข้อสอบใหม่
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="previewQuiz()">
                                <i class="bi bi-eye me-1"></i>ดูตัวอย่าง
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveAsDraft()">
                                <i class="bi bi-save me-1"></i>บันทึกฉบับร่าง
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Alert Container -->
                <div id="alertContainer"></div>
                
                <!-- Status Container -->
                <div id="statusContainer" class="alert alert-info status-container-hidden">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="statusMessage">กำลังโหลดระบบ...</span>
                </div>

                <!-- ฟอร์มแก้ไขข้อสอบ -->
                <form id="editQuizForm">
                    <!-- ข้อมูลพื้นฐาน -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                ข้อมูลพื้นฐาน
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="quizTitle" class="form-label">ชื่อข้อสอบ *</label>
                                        <input type="text" class="form-control" id="quizTitle" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="quizCourse" class="form-label">คอร์ส *</label>
                                        <select class="form-select" id="quizCourse" required>
                                            <option value="">เลือกคอร์ส</option>
                                            <!-- ข้อมูลคอร์สจะถูกโหลดจาก Firebase -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="quizDescription" class="form-label">คำอธิบาย</label>
                                        <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="quizInstructions" class="form-label">คำแนะนำ</label>
                                        <textarea class="form-control" id="quizInstructions" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="quizTimeLimit" class="form-label">เวลาจำกัด (นาที)</label>
                                        <input type="number" class="form-control" id="quizTimeLimit" min="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="quizAttempts" class="form-label">จำนวนครั้งที่ทำได้</label>
                                        <input type="number" class="form-control" id="quizAttempts" min="0" value="1">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="quizPassingScore" class="form-label">คะแนนผ่าน (%)</label>
                                        <input type="number" class="form-control" id="quizPassingScore" min="0" max="100" value="60">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="quizDueDate" class="form-label">กำหนดส่ง</label>
                                        <input type="datetime-local" class="form-control" id="quizDueDate">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ส่วนคำถาม -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-question-circle me-2"></i>
                                คำถาม
                            </h5>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addMultipleChoiceBtn">
                                    <i class="bi bi-list-ul me-1"></i>เลือกตอบ
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addTrueFalseBtn">
                                    <i class="bi bi-check2-circle me-1"></i>ถูก/ผิด
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addFillBlankBtn">
                                    <i class="bi bi-pencil-square me-1"></i>เติมคำ
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="questionsContainer">
                                <!-- Questions will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- การตั้งค่าข้อสอบ -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-gear me-2"></i>
                                การตั้งค่า
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoSubmit" checked>
                                        <label class="form-check-label" for="autoSubmit">
                                            ส่งข้อสอบอัตโนมัติเมื่อหมดเวลา
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="requireAllAnswers">
                                        <label class="form-check-label" for="requireAllAnswers">
                                            ต้องตอบทุกข้อ
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ปุ่มดำเนินการ -->
                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <i class="bi bi-arrow-left me-1"></i>กลับ
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" onclick="saveAsDraft()">
                                <i class="bi bi-save me-1"></i>บันทึกฉบับร่าง
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>บันทึกและเผยแพร่
                            </button>
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <!-- Quiz Preview Modal -->
    <div class="modal fade" id="quizPreviewModal" tabindex="-1" role="dialog" aria-labelledby="quizPreviewModalLabel" aria-modal="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quizPreviewModalLabel">
                        <i class="bi bi-eye me-2"></i>
                        ตัวอย่างข้อสอบ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด" tabindex="0"></button>
                </div>
                <div class="modal-body" id="quizPreviewModalBody">
                    <!-- Preview content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Quiz Modal -->
    <div class="modal fade" id="createQuizModal" tabindex="-1" role="dialog" aria-labelledby="createQuizModalLabel" aria-modal="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createQuizModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>สร้างข้อสอบใหม่
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด" tabindex="0"></button>
                </div>
                <form id="createQuizForm">
                    <div class="modal-body">
                        <!-- ข้อมูลพื้นฐานข้อสอบ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    ข้อมูลพื้นฐานข้อสอบ
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="modalQuizTitle" class="form-label">ชื่อข้อสอบ *</label>
                                            <input type="text" class="form-control" id="modalQuizTitle" placeholder="กรุณากรอกชื่อข้อสอบ" required="">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="modalQuizCourse" class="form-label">คอร์ส *</label>
                                            <select class="form-select" id="modalQuizCourse" required=""><option value="">เลือกคอร์ส</option></select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="modalQuizDescription" class="form-label">คำอธิบาย</label>
                                            <textarea class="form-control" id="modalQuizDescription" rows="3" placeholder="กรุณากรอกคำอธิบายข้อสอบ"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="modalQuizInstructions" class="form-label">คำแนะนำ</label>
                                            <textarea class="form-control" id="modalQuizInstructions" rows="3" placeholder="กรุณากรอกคำแนะนำสำหรับนักเรียน"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="modalQuizTimeLimit" class="form-label">เวลาจำกัด (นาที)</label>
                                            <input type="number" class="form-control" id="modalQuizTimeLimit" placeholder="0 = ไม่จำกัด" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="modalQuizAttempts" class="form-label">จำนวนครั้งที่ทำได้</label>
                                            <input type="number" class="form-control" id="modalQuizAttempts" placeholder="0 = ไม่จำกัด" min="0" value="1">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="modalQuizPassingScore" class="form-label">คะแนนผ่าน (%)</label>
                                            <input type="number" class="form-control" id="modalQuizPassingScore" placeholder="60" min="0" max="100" value="60">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="modalQuizDueDate" class="form-label">กำหนดส่ง</label>
                                            <input type="datetime-local" class="form-control" id="modalQuizDueDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- การตั้งค่าข้อสอบ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-gear me-2"></i>
                                    การตั้งค่า
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizShuffleQuestions" checked="">
                                            <label class="form-check-label" for="modalQuizShuffleQuestions">
                                                สุ่มลำดับคำถาม
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizShowResults" checked="">
                                            <label class="form-check-label" for="modalQuizShowResults">
                                                แสดงผลคะแนนทันที
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizShowCorrectAnswers" checked="">
                                            <label class="form-check-label" for="modalQuizShowCorrectAnswers">
                                                แสดงคำตอบที่ถูกต้อง
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizAllowReview" checked="">
                                            <label class="form-check-label" for="modalQuizAllowReview">
                                                อนุญาตให้ดูคำตอบซ้ำ
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizAutoSubmit">
                                            <label class="form-check-label" for="modalQuizAutoSubmit">
                                                ส่งข้อสอบอัตโนมัติเมื่อหมดเวลา
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="modalQuizIsActive" checked="">
                                            <label class="form-check-label" for="modalQuizIsActive">
                                                เปิดใช้งานทันที
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ส่วนคำถาม -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-question-circle me-2"></i>
                                    คำถาม
                                </h6>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="modalAddMultipleChoiceBtn">
                                        <i class="bi bi-list-ul me-1"></i>เลือกตอบ
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="modalAddTrueFalseBtn">
                                        <i class="bi bi-check2-circle me-1"></i>ถูก/ผิด
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="modalAddFillBlankBtn">
                                        <i class="bi bi-pencil-square me-1"></i>เติมคำ
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="modalQuestionsContainer">
                                    <!-- คำถามจะถูกเพิ่มที่นี่ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>สร้างข้อสอบ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase -->
    <script type="module" src="../../assets/js/firebase-config.js"></script>
    <script type="module" src="../../assets/js/auth.js"></script>
    <script type="module" src="../../assets/js/quiz-edit.js"></script>
    
    <script type="module">
        import { protectPage, displayUserInfo, createUserMenu, createMainMenu, logoutUser, checkSessionExpiry } from '../../assets/js/auth.js';
        
        // ตรวจสอบสิทธิ์การเข้าถึงหน้า (ผู้สอนและแอดมิน)
        protectPage(['instructor', 'admin']);
        
        // แสดงข้อมูลผู้ใช้
        displayUserInfo();
        
        // สร้างเมนูหลัก
        createMainMenu();
        
        // สร้างเมนูผู้ใช้
        createUserMenu();
        
        // จัดการการออกจากระบบ
        document.addEventListener('click', function(e) {
            if (e.target.closest('#logoutBtn') || e.target.closest('[data-action="logout"]')) {
                e.preventDefault();
                logoutUser().then(() => {
                    window.location.href = '../auth/login.html';
                });
            }
        });
        
        // ตรวจสอบ session ทุก 5 นาที
        setInterval(() => {
            checkSessionExpiry();
        }, 5 * 60 * 1000);

        // ตรวจสอบ Bootstrap และ Modal
        document.addEventListener('DOMContentLoaded', function() {
            // ตรวจสอบว่า Bootstrap โหลดแล้วหรือยัง
            if (typeof bootstrap !== 'undefined') {
                console.log('Bootstrap loaded successfully');
                
                // ตรวจสอบ Modal
                const createQuizModal = document.getElementById('createQuizModal');
                const quizPreviewModal = document.getElementById('quizPreviewModal');
                
                if (createQuizModal) {
                    const modal = new bootstrap.Modal(createQuizModal);
                    console.log('Create Quiz Modal initialized');
                    
                    // เพิ่ม event listener สำหรับการเปิด Modal
                    createQuizModal.addEventListener('show.bs.modal', function() {
                        console.log('Create Quiz Modal is opening');
                        loadCoursesForModal();
                        // จัดการ focus เมื่อ Modal เปิด
                        setTimeout(() => {
                            const firstInput = createQuizModal.querySelector('input, textarea, select');
                            if (firstInput) {
                                firstInput.focus();
                            }
                        }, 100);
                    });
                    
                    // จัดการ focus เมื่อ Modal ปิด
                    createQuizModal.addEventListener('hidden.bs.modal', function() {
                        console.log('Create Quiz Modal is closed');
                        // คืน focus ไปยังปุ่มที่เปิด Modal
                        const createQuizBtn = document.querySelector('[data-bs-target="#createQuizModal"]');
                        if (createQuizBtn) {
                            createQuizBtn.focus();
                        }
                    });
                }
                
                if (quizPreviewModal) {
                    const modal = new bootstrap.Modal(quizPreviewModal);
                    console.log('Quiz Preview Modal initialized');
                    
                    // จัดการ focus เมื่อ Modal ปิด
                    quizPreviewModal.addEventListener('hidden.bs.modal', function() {
                        console.log('Quiz Preview Modal is closed');
                        // คืน focus ไปยังปุ่มที่เปิด Modal
                        const previewBtn = document.querySelector('[onclick="previewQuiz()"]');
                        if (previewBtn) {
                            previewBtn.focus();
                        }
                    });
                }
            } else {
                console.error('Bootstrap not loaded');
                // Fallback: ใช้ vanilla JavaScript สำหรับ Modal
                setupFallbackModal();
            }
        });

        // Fallback Modal สำหรับกรณีที่ Bootstrap ไม่โหลด
        function setupFallbackModal() {
            const createQuizBtn = document.querySelector('[data-bs-target="#createQuizModal"]');
            const createQuizModal = document.getElementById('createQuizModal');
            const closeBtns = document.querySelectorAll('[data-bs-dismiss="modal"]');
            
            if (createQuizBtn && createQuizModal) {
                createQuizBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    createQuizModal.style.display = 'block';
                    createQuizModal.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // เพิ่ม backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.id = 'fallbackBackdrop';
                    document.body.appendChild(backdrop);
                });
            }
            
            // ปิด Modal
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        
                        // ลบ backdrop
                        const backdrop = document.getElementById('fallbackBackdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                });
            });
            
            // ปิด Modal เมื่อคลิก backdrop
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    const modal = document.querySelector('.modal.show');
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        e.target.remove();
                    }
                }
            });
        }

        // จัดการ Modal สร้างข้อสอบใหม่
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up quiz creation modal');
            
            // ตรวจสอบว่าปุ่มและ Modal มีอยู่จริง
            const createQuizBtn = document.querySelector('[data-bs-target="#createQuizModal"]');
            const createQuizModal = document.getElementById('createQuizModal');
            const createQuizForm = document.getElementById('createQuizForm');
            
            if (createQuizBtn) {
                console.log('Create quiz button found');
                createQuizBtn.addEventListener('click', function() {
                    console.log('Create quiz button clicked');
                });
            } else {
                console.error('Create quiz button not found');
            }
            
            if (createQuizModal) {
                console.log('Create quiz modal found');
            } else {
                console.error('Create quiz modal not found');
            }
            
            if (createQuizForm) {
                console.log('Create quiz form found');
                // จัดการการส่งฟอร์มสร้างข้อสอบ
                createQuizForm.addEventListener('submit', handleCreateQuiz);
            } else {
                console.error('Create quiz form not found');
            }
            
            // โหลดข้อมูลคอร์สสำหรับ Modal
            loadCoursesForModal();
            
            // จัดการปุ่มเพิ่มคำถามใน Modal
            const modalAddMultipleChoiceBtn = document.getElementById('modalAddMultipleChoiceBtn');
            const modalAddTrueFalseBtn = document.getElementById('modalAddTrueFalseBtn');
            const modalAddFillBlankBtn = document.getElementById('modalAddFillBlankBtn');
            
            if (modalAddMultipleChoiceBtn) {
                modalAddMultipleChoiceBtn.addEventListener('click', () => addModalQuestion('multiple-choice'));
            }
            if (modalAddTrueFalseBtn) {
                modalAddTrueFalseBtn.addEventListener('click', () => addModalQuestion('true-false'));
            }
            if (modalAddFillBlankBtn) {
                modalAddFillBlankBtn.addEventListener('click', () => addModalQuestion('fill-blank'));
            }
        });

        // โหลดข้อมูลคอร์สสำหรับ Modal
        async function loadCoursesForModal() {
            try {
                const { db } = await import('../../assets/js/firebase-config.js');
                const { collection, getDocs, query, where } = await import('firebase/firestore');
                
                const user = JSON.parse(localStorage.getItem('user'));
                const coursesRef = collection(db, 'courses');
                const q = query(coursesRef, where('instructorId', '==', user.uid));
                const querySnapshot = await getDocs(q);
                
                const courseSelect = document.getElementById('modalQuizCourse');
                courseSelect.innerHTML = '<option value="">เลือกคอร์ส</option>';
                
                querySnapshot.forEach((doc) => {
                    const course = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = course.title;
                    courseSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading courses:', error);
                showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูลคอร์ส', 'danger');
            }
        }

        // จัดการการส่งฟอร์มสร้างข้อสอบ
        async function handleCreateQuiz(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const quizData = {
                title: document.getElementById('modalQuizTitle').value,
                courseId: document.getElementById('modalQuizCourse').value,
                description: document.getElementById('modalQuizDescription').value,
                instructions: document.getElementById('modalQuizInstructions').value,
                timeLimit: parseInt(document.getElementById('modalQuizTimeLimit').value) || 0,
                attempts: parseInt(document.getElementById('modalQuizAttempts').value) || 1,
                passingScore: parseInt(document.getElementById('modalQuizPassingScore').value) || 60,
                dueDate: document.getElementById('modalQuizDueDate').value,
                shuffleQuestions: document.getElementById('modalQuizShuffleQuestions').checked,
                showResults: document.getElementById('modalQuizShowResults').checked,
                showCorrectAnswers: document.getElementById('modalQuizShowCorrectAnswers').checked,
                allowReview: document.getElementById('modalQuizAllowReview').checked,
                autoSubmit: document.getElementById('modalQuizAutoSubmit').checked,
                isActive: document.getElementById('modalQuizIsActive').checked,
                questions: getModalQuestions(),
                createdAt: new Date(),
                updatedAt: new Date()
            };

            try {
                const { db } = await import('../../assets/js/firebase-config.js');
                const { collection, addDoc } = await import('firebase/firestore');
                
                const user = JSON.parse(localStorage.getItem('user'));
                quizData.instructorId = user.uid;
                
                const docRef = await addDoc(collection(db, 'quizzes'), quizData);
                
                showAlert('สร้างข้อสอบสำเร็จแล้ว!', 'success');
                
                // ปิด Modal และรีเซ็ตฟอร์ม
                const modal = bootstrap.Modal.getInstance(document.getElementById('createQuizModal'));
                modal.hide();
                e.target.reset();
                document.getElementById('modalQuestionsContainer').innerHTML = '';
                
                // รีโหลดหน้าหรือไปยังหน้าจัดการข้อสอบ
                setTimeout(() => {
                    window.location.href = 'manage-quizzes.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                showAlert('เกิดข้อผิดพลาดในการสร้างข้อสอบ', 'danger');
            }
        }

        // เพิ่มคำถามใน Modal
        function addModalQuestion(type) {
            const container = document.getElementById('modalQuestionsContainer');
            const questionId = 'modal_question_' + Date.now();
            
            let questionHTML = '';
            
            switch(type) {
                case 'multiple-choice':
                    questionHTML = createMultipleChoiceQuestionHTML(questionId, true);
                    break;
                case 'true-false':
                    questionHTML = createTrueFalseQuestionHTML(questionId, true);
                    break;
                case 'fill-blank':
                    questionHTML = createFillBlankQuestionHTML(questionId, true);
                    break;
            }
            
            container.insertAdjacentHTML('beforeend', questionHTML);
        }

        // สร้าง HTML สำหรับคำถามแบบเลือกตอบ
        function createMultipleChoiceQuestionHTML(questionId, isModal = false) {
            return `
                <div class="card mb-3" id="${questionId}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">คำถามแบบเลือกตอบ</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion('${questionId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">คำถาม *</label>
                            <textarea class="form-control" name="question" required placeholder="กรุณากรอกคำถาม"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ตัวเลือก</label>
                            <div id="options_${questionId}">
                                <div class="input-group mb-2">
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" name="correct_${questionId}" value="0" required>
                                    </div>
                                    <input type="text" class="form-control" name="option_${questionId}_0" placeholder="ตัวเลือกที่ 1" required>
                                </div>
                                <div class="input-group mb-2">
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" name="correct_${questionId}" value="1" required>
                                    </div>
                                    <input type="text" class="form-control" name="option_${questionId}_1" placeholder="ตัวเลือกที่ 2" required>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addOption('${questionId}')">
                                <i class="bi bi-plus"></i> เพิ่มตัวเลือก
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">คำอธิบาย (ไม่บังคับ)</label>
                            <textarea class="form-control" name="explanation" placeholder="คำอธิบายคำตอบ"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // สร้าง HTML สำหรับคำถามแบบถูก/ผิด
        function createTrueFalseQuestionHTML(questionId, isModal = false) {
            return `
                <div class="card mb-3" id="${questionId}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">คำถามแบบถูก/ผิด</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion('${questionId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">คำถาม *</label>
                            <textarea class="form-control" name="question" required placeholder="กรุณากรอกคำถาม"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">คำตอบที่ถูกต้อง *</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_${questionId}" value="true" required>
                                <label class="form-check-label">ถูก</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_${questionId}" value="false" required>
                                <label class="form-check-label">ผิด</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">คำอธิบาย (ไม่บังคับ)</label>
                            <textarea class="form-control" name="explanation" placeholder="คำอธิบายคำตอบ"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // สร้าง HTML สำหรับคำถามแบบเติมคำ
        function createFillBlankQuestionHTML(questionId, isModal = false) {
            return `
                <div class="card mb-3" id="${questionId}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">คำถามแบบเติมคำ</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion('${questionId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">คำถาม *</label>
                            <textarea class="form-control" name="question" required placeholder="กรุณากรอกคำถาม (ใช้ ___ สำหรับช่องว่าง)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">คำตอบที่ถูกต้อง *</label>
                            <input type="text" class="form-control" name="correct_${questionId}" required placeholder="กรุณากรอกคำตอบที่ถูกต้อง">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">คำอธิบาย (ไม่บังคับ)</label>
                            <textarea class="form-control" name="explanation" placeholder="คำอธิบายคำตอบ"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // เพิ่มตัวเลือกสำหรับคำถามแบบเลือกตอบ
        function addOption(questionId) {
            const optionsContainer = document.getElementById(`options_${questionId}`);
            const optionCount = optionsContainer.children.length;
            
            const optionHTML = `
                <div class="input-group mb-2">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="radio" name="correct_${questionId}" value="${optionCount}" required>
                    </div>
                    <input type="text" class="form-control" name="option_${questionId}_${optionCount}" placeholder="ตัวเลือกที่ ${optionCount + 1}" required>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
        }

        // ลบคำถาม
        function removeQuestion(questionId) {
            const questionElement = document.getElementById(questionId);
            if (questionElement) {
                questionElement.remove();
            }
        }

        // ดึงข้อมูลคำถามจาก Modal
        function getModalQuestions() {
            const questions = [];
            const questionCards = document.querySelectorAll('#modalQuestionsContainer .card');
            
            questionCards.forEach((card, index) => {
                const questionId = card.id;
                const questionText = card.querySelector('textarea[name="question"]').value;
                const explanation = card.querySelector('textarea[name="explanation"]')?.value || '';
                
                // ตรวจสอบประเภทคำถาม
                if (card.querySelector('input[type="radio"][name^="correct_"]')) {
                    const correctAnswer = card.querySelector('input[type="radio"][name^="correct_"]:checked')?.value;
                    
                    if (card.querySelector('.input-group-text')) {
                        // คำถามแบบเลือกตอบ
                        const options = [];
                        const optionInputs = card.querySelectorAll('input[name^="option_"]');
                        optionInputs.forEach((input, optIndex) => {
                            options.push({
                                text: input.value,
                                isCorrect: optIndex.toString() === correctAnswer
                            });
                        });
                        
                        questions.push({
                            type: 'multiple-choice',
                            question: questionText,
                            options: options,
                            explanation: explanation,
                            order: index + 1
                        });
                    } else {
                        // คำถามแบบถูก/ผิด
                        questions.push({
                            type: 'true-false',
                            question: questionText,
                            correctAnswer: correctAnswer === 'true',
                            explanation: explanation,
                            order: index + 1
                        });
                    }
                } else {
                    // คำถามแบบเติมคำ
                    const correctAnswer = card.querySelector('input[name^="correct_"]').value;
                    questions.push({
                        type: 'fill-blank',
                        question: questionText,
                        correctAnswer: correctAnswer,
                        explanation: explanation,
                        order: index + 1
                    });
                }
            });
            
            return questions;
        }

        // แสดง Alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ปิด"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHTML;
            
            // ลบ Alert หลังจาก 5 วินาที
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // แสดงสถานะ
        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('statusContainer');
            const statusMessage = document.getElementById('statusMessage');
            
            if (statusContainer && statusMessage) {
                statusMessage.textContent = message;
                statusContainer.className = `alert alert-${type}`;
                statusContainer.classList.remove('status-container-hidden');
                
                // ซ่อนสถานะหลังจาก 3 วินาที
                setTimeout(() => {
                    statusContainer.classList.add('status-container-hidden');
                }, 3000);
            }
        }

        // ตรวจสอบและแสดงสถานะการโหลด
        function checkSystemStatus() {
            const createQuizBtn = document.querySelector('[data-bs-target="#createQuizModal"]');
            const createQuizModal = document.getElementById('createQuizModal');
            const bootstrapLoaded = typeof bootstrap !== 'undefined';
            
            let statusMessage = '';
            
            if (!createQuizBtn) {
                statusMessage = 'ไม่พบปุ่มสร้างข้อสอบ';
            } else if (!createQuizModal) {
                statusMessage = 'ไม่พบ Modal สร้างข้อสอบ';
            } else if (!bootstrapLoaded) {
                statusMessage = 'Bootstrap ยังไม่โหลด - ใช้ fallback mode';
            } else {
                statusMessage = 'ระบบพร้อมใช้งาน';
                return; // ไม่แสดงสถานะถ้าทุกอย่างปกติ
            }
            
            showStatus(statusMessage, 'warning');
        }

        // เรียกใช้การตรวจสอบสถานะหลังจากโหลดเสร็จ
        window.addEventListener('load', function() {
            setTimeout(checkSystemStatus, 1000);
        });

        // ฟังก์ชันสำหรับจัดการ accessibility
        function setupAccessibility() {
            // จัดการ keyboard navigation สำหรับ Modal
            document.addEventListener('keydown', function(e) {
                const activeModal = document.querySelector('.modal.show');
                if (!activeModal) return;
                
                // ปิด Modal ด้วย Escape key
                if (e.key === 'Escape') {
                    const closeBtn = activeModal.querySelector('.btn-close');
                    if (closeBtn) {
                        closeBtn.click();
                    }
                }
                
                // จัดการ Tab key ใน Modal
                if (e.key === 'Tab') {
                    const focusableElements = activeModal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
            });
            
            // จัดการ focus trap สำหรับ Modal
            document.addEventListener('focusin', function(e) {
                const activeModal = document.querySelector('.modal.show');
                if (!activeModal) return;
                
                if (!activeModal.contains(e.target)) {
                    const focusableElements = activeModal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                }
            });
        }

        // เรียกใช้การตั้งค่า accessibility
        document.addEventListener('DOMContentLoaded', setupAccessibility);
    </script>
</body>
</html>
